# ğŸŒ€ BETRIX - Multi-Sport AI Telegram Bot Platform

**Production-ready Telegram bot** with AI-powered analysis, multi-provider resilience, free live sports data, real-time prefetching, and comprehensive monitoring.

## âœ¨ Key Features

### ğŸ¤– Intelligent AI Layer
- **Multi-Provider Chain**: Gemini â†’ Azure â†’ HuggingFace â†’ LocalAI (automatic fallback)
- **Defensive Handling**: Empty response recovery, MAX_TOKENS retry, per-user token trimming
- **Observability**: Real-time `ai:active` tracking, debug endpoints

### ğŸ“Š Free Live Sports Data (Always Live)
- **OpenLigaDB**: No-auth leagues, matches, standings (30s cache)
- **BBC/Guardian/ESPN RSS**: Real-time headlines (60s cache)
- **ScoreBat**: Free highlights feed (120s cache)
- **football-data.co.uk**: Historical fixtures, results, odds (1h cache)
- **Polite Scrapers**: FBref/Understat (2h cache, robots.txt respected)

### âš¡ Advanced Infrastructure
- **Real-time Prefetch Scheduler**: Configurable interval (default 60s), warms all data caches
- **Exponential Backoff**: Automatic provider protection on repeated failures
- **Pub/Sub Broadcasting**: `prefetch:updates` and `prefetch:error` to all clients
- **WebSocket Integration**: Live client sync via real-time events
- **Monitoring Dashboard**: `/monitor.html` with auto-refresh (10s)

### ğŸ¯ Tier System
- **Free**: 30 requests/minute
- **Member**: 60 requests/minute  
- **VVIP**: 150 requests/minute
- **Admin**: 300 requests/minute

### ğŸ’° Payment & Subscriptions (PayPal)
- 3-tier pricing model per sport
- All-access bundle option
- Referral rewards system
- Leaderboards

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Telegram Bot Users                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                           â”‚
         Webhook (/webhook)          WebSocket (/ws)
              â”‚                           â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
      â”‚   Express Web Server (5000)    â”‚ â”‚
      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
      â”‚ â”‚ â€¢ HTTP Endpoints             â”‚ â”‚
      â”‚ â”‚ â€¢ Free Data Sources (/live,  â”‚â”€â”¼â”€â–¶ Broadcast prefetch
      â”‚ â”‚   /standings, /news, etc.)   â”‚ â”‚   events
      â”‚ â”‚ â€¢ Admin Endpoints (/admin)   â”‚ â”‚
      â”‚ â”‚ â€¢ Monitor Dashboard (/monitor)
      â”‚ â”‚ â€¢ Redis PubSub Subscriber    â”‚
      â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
        â”‚                                 â”‚
        â”‚ Queue to Redis                  â”‚
        â”‚ (telegram:updates)              â”‚
        â”‚                                 â”‚
      â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
      â”‚   Worker Process               â”‚ â”‚
      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
      â”‚ â”‚ â€¢ BRPOPLPUSH Queue Handler   â”‚ â”‚
      â”‚ â”‚ â€¢ AI Composite Chain         â”‚ â”‚
      â”‚ â”‚ â€¢ Prefetch Scheduler         â”‚â”€â”¼â”€â–¶ Pub/Sub Events
      â”‚ â”‚ â€¢ Handler Router             â”‚ â”‚
      â”‚ â”‚ â€¢ Redis Subscriber (observer)â”‚ â”‚
      â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
        â”‚                                 â”‚
        â”‚ All read/write via Redis        â”‚
        â”‚                                 â”‚
      â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
      â”‚    Redis (ioredis)              â”‚ â”‚
      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
      â”‚ â”‚ Queues:                       â”‚ â”‚
      â”‚ â”‚  â€¢ telegram:updates           â”‚ â”‚
      â”‚ â”‚  â€¢ telegram:processing        â”‚ â”‚
      â”‚ â”‚                               â”‚ â”‚
      â”‚ â”‚ Caches:                       â”‚ â”‚
      â”‚ â”‚  â€¢ prefetch:rss:*             â”‚ â”‚
      â”‚ â”‚  â€¢ prefetch:openligadb:*      â”‚ â”‚
      â”‚ â”‚  â€¢ prefetch:scorebat:*        â”‚ â”‚
      â”‚ â”‚  â€¢ prefetch:footballdata:*    â”‚ â”‚
      â”‚ â”‚                               â”‚ â”‚
      â”‚ â”‚ State:                        â”‚ â”‚
      â”‚ â”‚  â€¢ prefetch:failures:*        â”‚ â”‚
      â”‚ â”‚  â€¢ prefetch:next:* (backoff)  â”‚ â”‚
      â”‚ â”‚  â€¢ ai:active (provider)       â”‚ â”‚
      â”‚ â”‚  â€¢ worker:heartbeat           â”‚ â”‚
      â”‚ â”‚  â€¢ system:logs                â”‚ â”‚
      â”‚ â”‚  â€¢ context:*:history          â”‚ â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
        â”‚                                 â”‚
        â”‚ Pub/Sub Channels:               â”‚
        â”‚ â€¢ prefetch:updates              â”‚
        â”‚ â€¢ prefetch:error                â”‚
        â”‚                                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ Quick Start

### Prerequisites
- Node.js â‰¥ 20
- Redis (local or cloud)
- Telegram Bot Token

### Installation
```bash
# Clone and install
git clone https://github.com/maryreaky/betrix-ui-replit-.git
cd betrix-ui-replit-
npm install

# Configure environment
cp .env.example .env
# Edit .env with your tokens and Redis URL
```

### Environment Variables
```env
# Required
TELEGRAM_TOKEN=your_bot_token
TELEGRAM_WEBHOOK_SECRET=your_webhook_secret
REDIS_URL=redis://default:password@host:6379

# Optional AI Providers (uses fallback chain if not set)
GEMINI_API_KEY=your_gemini_key
AZURE_ENDPOINT=https://your.openai.azure.com/
AZURE_KEY=your_azure_key
HUGGINGFACE_TOKEN=your_hf_token

# Optional Prefetch Config
PREFETCH_INTERVAL_SECONDS=60          # Default: 60s
PREFETCH_BASE_BACKOFF_SECONDS=60      # Initial backoff
PREFETCH_MAX_BACKOFF_SECONDS=3600     # Max 1 hour
```

### Run Tests
```bash
npm test
# Expected: All 10 tests passing
# â€¢ CacheService tests (5)
# â€¢ OpenLigaDB/RSSAggregator (4)
# â€¢ smoke tests (1)
```

### Start Services
```bash
# Terminal 1: Start Worker (processes queue + prefetch)
node src/worker-final.js

# Terminal 2: Start Web Server (HTTP + WebSocket)
node src/app.js
```

### Access Points
- **Bot**: Message your Telegram bot
- **Web Server**: `http://localhost:5000`
- **Health Check**: `curl http://localhost:5000/health`
- **Monitor Dashboard**: `http://localhost:5000/monitor.html`
- **Metrics**: `GET /monitor` (JSON API)

## ğŸ“– Documentation

| Document | Purpose |
|----------|---------|
| [INFRASTRUCTURE_GUIDE.md](INFRASTRUCTURE_GUIDE.md) | Complete setup, architecture, monitoring, troubleshooting |
| [API_REFERENCE.md](API_REFERENCE.md) | All HTTP endpoints, WebSocket, Pub/Sub channels |
| [LEGAL.md](LEGAL.md) | Data source reuse, attribution, compliance |
| [PREFETCH_POLICY.md](PREFETCH_POLICY.md) | Recommended intervals, TTL policies, backoff tuning |

## ğŸ§ª Testing

```bash
# Run all tests (10 tests)
npm test

# Example output:
# âœ” CacheService - basic get/set operations
# âœ” CacheService - rate limiting within bounds
# âœ” CacheService - rate limiting exceeds bounds
# âœ” CacheService - handles null/undefined values
# âœ” CacheService - serialization/deserialization
# âœ” OpenLigaDBService instantiates without cache
# âœ” OpenLigaDBService instantiates with CacheService
# âœ” RSSAggregator instantiates without cache
# âœ” RSSAggregator instantiates with cache
# âœ” Smoke tests
```

## ğŸ›ï¸ Monitoring

### Dashboard
Visit **`http://localhost:5000/monitor.html`** for:
- System status and uptime
- Worker process health
- Active AI provider
- Queue status and pending updates

## âš ï¸ TLS Interception & Redis (Troubleshooting)

If your environment has an intercepting proxy (corporate or security appliance) you may see TLS certificate verification errors from Node (but PowerShell/browser may succeed). Two remediation options:

- Install the proxy CA into the OS trust store on the host running Node (Windows example): run the provided helper `scripts/install-proxy-ca.ps1` as Administrator with the `.cer` file from the proxy operator.
- Or ask the network/proxy team to allowlist `api.sportmonks.com` (or other upstream hosts) so the proxy does not re-sign those requests.

For development only you can temporarily disable certificate verification for SportMonks requests by setting:

```powershell
$env:SPORTSMONKS_INSECURE='true'
```

Do NOT enable this in production. After installing the proxy CA or allowlisting the host, unset the flag and re-run the service.

Redis authentication
- Provide `REDIS_URL` including credentials to allow the app to connect without `NOAUTH` warnings. Example:

```env
REDIS_URL=redis://default:yourpassword@redis-host.example:6379
```

We also handle a local fallback (if `REDIS_URL` is not set) and log Redis errors. Ensure credentials are correct in your environment to avoid repeated `NOAUTH` messages.
- Prefetch source health (failure counts)
- Last update times for each data source

### API Monitoring
```bash
# Get real-time metrics
curl http://localhost:5000/monitor

# Check worker heartbeat
redis-cli GET worker:heartbeat

# View system logs
redis-cli LRANGE system:logs 0 -20

# Check prefetch failures
redis-cli GET prefetch:failures:rss
```

### WebSocket Events
```javascript
const ws = new WebSocket('ws://localhost:5000/');

ws.addEventListener('message', (e) => {
  const msg = JSON.parse(e.data);
  if (msg.type === 'prefetch:updates') {
    console.log('Data refreshed:', msg.data.type);
  }
});
```

## ğŸ”§ Configuration

### Cache Policies (`src/config/cache-config.js`)
```javascript
export const CACHE_CONFIG = {
  rss: { ttlSeconds: 60, rateLimit: 30, ... },
  openligadb: { ttlSeconds: 30, rateLimit: 60, ... },
  scorebat: { ttlSeconds: 120, rateLimit: 20, ... },
  footballdata: { ttlSeconds: 3600, rateLimit: 5, ... },
  scrapers: { ttlSeconds: 7200, rateLimit: 10, ... }
};
```

### Backoff Policy
```javascript
// On failure: 2^(failures-1) * base, capped at max
// Failure 1: 60s delay
// Failure 2: 120s delay
// Failure 3: 240s delay
// ... up to 1 hour max
```

## ğŸ“Š Redis Data Structure

```
Keys Used:
- telegram:updates          (List) - Pending Telegram updates
- telegram:processing       (List) - Updates being processed
- prefetch:rss:football     (String) - Cached RSS feed data
- prefetch:openligadb:*     (String) - Cached league/match data
- prefetch:scorebat:free    (String) - Cached highlights
- prefetch:failures:*       (String) - Failure count per source
- prefetch:next:*           (String) - Next retry time (backoff)
- ai:active                 (String) - Current AI provider name
- worker:heartbeat          (String) - Worker last-seen timestamp
- system:logs               (List) - Application logs
- context:*:history         (List) - User conversation history
- user:tier:*               (String) - User subscription tier

Pub/Sub Channels:
- prefetch:updates          - Data source refresh events
- prefetch:error            - Failure events
```

## ğŸŒ Deployment

### Recommended Setup
- **Web Server**: Render, Heroku, Railway, or self-hosted
- **Worker**: Separate dyno/instance (background job)
- **Redis**: Upstash, Redis Cloud, or managed provider
- **Secrets**: Environment variables (no hardcoding)

### Production Checklist
- [ ] Set all required env vars
- [ ] Configure Redis with persistence (AOF or RDB)
- [ ] Enable SSL/TLS for WebSocket
- [ ] Set up error logging (Sentry, LogRocket)
- [ ] Configure backup/restore procedures
- [ ] Test failover scenarios
- [ ] Document monitoring alerts
- [ ] Set up uptime monitoring

## ğŸ¤ Contributing

1. Fork the repository
2. Create a feature branch
3. Add tests for new functionality
4. Submit a pull request

## ğŸ“„ License

MIT - See LICENSE file

## ğŸ”— Resources

- [Telegram Bot API](https://core.telegram.org/bots/api)
- [Google Gemini API](https://ai.google.dev/)
- [OpenLigaDB API](https://www.openligadb.de/)
- [ioredis Documentation](https://github.com/luin/ioredis)

---

**BETRIX v3.0** â€” Intelligent Sports Betting Analytics | Production Ready âœ…

## ğŸš€ Quick Start
```bash
npm install
export REDIS_URL=redis://localhost:6379
export TELEGRAM_TOKEN=your_token
bash start.sh